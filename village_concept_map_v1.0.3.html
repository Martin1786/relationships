<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Village Relationships Concept Map</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="style.css">  
    <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    
</head>
<body>
    <div class="app-bar">
        <button class="menu-btn" id="openDrawerBtn" aria-label="Open menu">‚ò∞</button>
        <span class="app-bar-title" id="appBarTitle"></span>
    </div>
    <div class="drawer-backdrop" id="drawerBackdrop"></div>
        <nav class="drawer" id="sideDrawer" aria-label="Main menu">
            <div class="drawer-header">Menu</div>
            <div class="drawer-actions">
        <button class="drawer-action-btn" onclick="openAddRelationshipModal()" title="Add Relationship">‚ûï Add Relationship</button>
        <button class="drawer-action-btn" onclick="openAddPersonModal()" title="Add Person">‚ûï Add Person</button>
        <button class="drawer-action-btn" onclick="openDataEntryModal()" title="Open Data Entry Form">‚úèÔ∏è Open Data Entry Form</button>
        <button class="drawer-action-btn" onclick="openOptionsModal()" title="Options">‚öôÔ∏è Options</button>
        <div style="border-top: 1px solid #e0e0e0; margin: 10px 0;"></div>
        <button class="drawer-action-btn" onclick="document.getElementById('gedcomFile').click()" title="Upload GEDCOM File">üìÅ Upload GEDCOM File</button>
        <button class="drawer-action-btn" onclick="document.getElementById('jsonFile').click()" title="Upload JSON File">üóÇÔ∏è Upload JSON File</button>
        <button class="drawer-action-btn reset-btn" onclick="resetData()" title="Reset Data">üóëÔ∏è Reset Data</button>
        <button class="drawer-action-btn" onclick="downloadMapAsJSON()" title="Download Map as JSON">‚¨áÔ∏è Download Map as JSON</button>
        <button class="drawer-action-btn" onclick="openAboutModal()" title="About / Instructions">‚ÑπÔ∏è About / Instructions</button>
    </div>
    </nav>
    <div class="container">
        <p class="subtitle">Exploring the interconnected relationships in a small village community</p>
        
        <div class="legend">
            <div class="legend-item legend-all active" data-type="all" tabindex="0" title="Show All" onclick="filterConnections('all')">
                <div class="legend-dot" style="background: #34495e;"></div>
                <span id="legendAllLabel"></span>
            </div>
            <div class="legend-item legend-family" data-type="family" tabindex="0" title="Family Only" onclick="filterConnections('family')">
                <div class="legend-dot" style="background: #e74c3c;"></div>
                <span id="legendFamilyLabel"></span>
            </div>
            <div class="legend-item legend-work" data-type="work" tabindex="0" title="Work Only" onclick="filterConnections('work')">
                <div class="legend-dot" style="background: #3498db;"></div>
               <span id="legendWorkLabel"></span>
            </div>
            <div class="legend-item legend-social" data-type="social" tabindex="0" title="Social Only" onclick="filterConnections('social')">
                <div class="legend-dot" style="background: #2ecc71;"></div>
                <span id="legendSocialLabel"></span>
            </div>
        </div>
        
        <div class="map-container" id="mapContainer"></div>
        
        
        <!-- Import and data entry actions are now in the drawer -->
        
        <!-- Instructions now in About modal -->
        
        <div id="uploadStatus" class="upload-status"></div>
    </div>

    <div id="editPersonModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:2000; align-items:center; justify-content:center;">
      <div style="background:#fff; padding:24px 32px; border-radius:10px; min-width:300px; box-shadow:0 8px 32px rgba(0,0,0,0.2); position:relative;">
        <h3>Edit Person</h3>
        <form id="editPersonForm">
          <label>Name:<br><input type="text" id="editPersonName" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Role:<br><input type="text" id="editPersonRole" style="width:100%; margin-bottom:10px;"></label><br>
          <div style="text-align:right;">
            <button type="button" id="cancelEditPerson" style="margin-right:10px;">Cancel</button>
            <button type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>

    <div id="editConnectionModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:2000; align-items:center; justify-content:center;">
      <div style="background:#fff; padding:24px 32px; border-radius:10px; min-width:340px; box-shadow:0 8px 32px rgba(0,0,0,0.2); position:relative;">
        <h3>Edit Relationship</h3>
        <form id="editConnectionForm">
          <label>Type/Label:<br><input type="text" id="editConnLabel" placeholder="Relationship type (e.g. Friends, Married)" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Category:<br>
            <select id="editConnType" style="width:100%; margin-bottom:10px;">
              <option value="family">Family</option>
              <option value="work">Work</option>
              <option value="social">Social</option>
            </select>
          </label><br>
          <label>Source Type:<br><input type="text" id="editConnSourceType" placeholder="Source type (e.g. Interview)" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Source Details:<br><input type="text" id="editConnSourceDetails" placeholder="Source details (e.g. Conversation notes)" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Date:<br><input type="text" id="editConnDate" placeholder="Date (e.g. 2025-06-01)" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Location:<br><input type="text" id="editConnLocation" placeholder="Location (e.g. London)" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Notes:<br><input type="text" id="editConnNotes" placeholder="Notes" style="width:100%; margin-bottom:10px;"></label><br>
          <div style="text-align:right;">
            <button type="button" id="cancelEditConnection" style="margin-right:10px;">Cancel</button>
            <button type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>

    <div id="addRelationshipModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:2000; align-items:center; justify-content:center;">
      <div style="background:#fff; padding:24px 32px; border-radius:10px; min-width:340px; box-shadow:0 8px 32px rgba(0,0,0,0.2); position:relative;">
        <h3>Add Relationship</h3>
        <form id="addRelationshipForm">
          <label>Person 1:<br><select id="addRelPerson1" style="width:100%; margin-bottom:10px;"></select></label><br>
          <label>Person 2:<br><select id="addRelPerson2" style="width:100%; margin-bottom:10px;"></select></label><br>
          <label>Type/Label:<br><input type="text" id="addRelLabel" placeholder="Relationship type (e.g. Friends, Married)" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Category:<br>
            <select id="addRelType" style="width:100%; margin-bottom:10px;">
              <option value="family">Family</option>
              <option value="work">Work</option>
              <option value="social">Social</option>
            </select>
          </label><br>
          <label>Source Type:<br><input type="text" id="addRelSourceType" placeholder="Source type (e.g. Interview)" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Source Details:<br><input type="text" id="addRelSourceDetails" placeholder="Source details (e.g. Conversation notes)" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Date:<br><input type="text" id="addRelDate" placeholder="Date (e.g. 2025-06-01)" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Location:<br><input type="text" id="addRelLocation" placeholder="Location (e.g. London)" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Notes:<br><input type="text" id="addRelNotes" placeholder="Notes" style="width:100%; margin-bottom:10px;"></label><br>
          <div style="text-align:right;">
            <button type="button" id="cancelAddRelationship" style="margin-right:10px;">Cancel</button>
            <button type="submit">Add</button>
          </div>
        </form>
      </div>
    </div>

    <div id="dataEntryModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:2000; align-items:center; justify-content:center;">
      <div style="background:#fff; padding:24px 32px; border-radius:10px; min-width:340px; box-shadow:0 8px 32px rgba(0,0,0,0.2); position:relative;">
        <h3>Add New Relationship</h3>
        <form id="dataEntryForm">
          <label>Person 1 Name:<br><input type="text" id="entryPerson1" placeholder="First person's name" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Person 2 Name:<br><input type="text" id="entryPerson2" placeholder="Second person's name" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Type/Label:<br><input type="text" id="entryLabel" placeholder="Relationship type (e.g. Friends, Married)" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Category:<br><input type="text" id="entryType" placeholder="family, work, or social" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Source Type:<br><input type="text" id="entrySourceType" placeholder="Source type (e.g. Interview)" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Source Details:<br><input type="text" id="entrySourceDetails" placeholder="Source details (e.g. Conversation notes)" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Date:<br><input type="text" id="entryDate" placeholder="Date (DD/MM/YYYY)" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Location:<br><input type="text" id="entryLocation" placeholder="Location (e.g. London)" style="width:100%; margin-bottom:10px;"></label><br>
          <label>Notes:<br><input type="text" id="entryNotes" placeholder="Notes" style="width:100%; margin-bottom:10px;"></label><br>
          <div style="text-align:right;">
            <button type="button" id="cancelDataEntry" style="margin-right:10px;">Cancel</button>
            <button type="submit">Add</button>
          </div>
        </form>
      </div>
    </div>

    <div id="addPersonModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:2000; align-items:center; justify-content:center;">
      <div style="background:#fff; padding:24px 32px; border-radius:10px; min-width:300px; box-shadow:0 8px 32px rgba(0,0,0,0.2); position:relative;">
        <h3>Add Person</h3>
        <form id="addPersonForm">
          <label>Name:<br><input type="text" id="addPersonName" style="width:100%; margin-bottom:10px;" required></label><br>
          <label>Role:<br><input type="text" id="addPersonRole" style="width:100%; margin-bottom:10px;"></label><br>
          <div style="text-align:right;">
            <button type="button" id="cancelAddPerson" style="margin-right:10px;">Cancel</button>
            <button type="submit">Add</button>
          </div>
        </form>
      </div>
    </div>
    <!-- End of HTML content -->

    <script src="appConstants.js"></script>
    <script src="utils.js"></script>
    <script src="dataHandlers.js"></script>
    <script src="modals.js"></script>
    <script src="mapRender.js"></script>
    <script>
        // Ensure global arrays for people and connections
        window.people = window.people || [];
        window.connections = window.connections || [];

        window.addEventListener('DOMContentLoaded', function() {
            // App bar title
            if (typeof APP_TITLE !== 'undefined') {
                document.getElementById('appBarTitle').textContent = APP_TITLE;
            }
            // Legend labels
            document.getElementById('legendAllLabel').textContent = 'All';
            document.getElementById('legendFamilyLabel').textContent = 'Family';
            document.getElementById('legendWorkLabel').textContent = 'Work';
            document.getElementById('legendSocialLabel').textContent = 'Social';
            // Drawer button labels
            if (typeof BUTTON_LABELS !== 'undefined') {
                document.getElementById('drawerDownloadJsonBtn').textContent = BUTTON_LABELS.downloadJson;
                document.getElementById('drawerAddRelationshipBtn').textContent = BUTTON_LABELS.addRelationship;
                document.getElementById('drawerAddPersonBtn').textContent = BUTTON_LABELS.addPerson;
                document.getElementById('drawerOpenDataEntryBtn').textContent = BUTTON_LABELS.openDataEntry;
                document.getElementById('drawerResetDataBtn').textContent = BUTTON_LABELS.resetData;
            }
            // Info panel instructions
            if (typeof INSTRUCTIONS !== 'undefined') {
                document.getElementById('infoPanel').innerHTML = '<strong>How to use:</strong> ' + INSTRUCTIONS.howToUse;
            }
        });

        // Load initial data from village_map.json on page load
        window.addEventListener('load', function() {
            fetch('village_map.json')
                .then(response => {
                    if (!response.ok) throw new Error('No default JSON found');
                    return response.json();
                })
                .then(jsonData => {
                    if (jsonData.people && jsonData.connections) {
                        window.people = [];
                        window.connections = [];
                        if (jsonData.box_color) window.BOX_COLOR = jsonData.box_color;
                        if (jsonData.box_text_color) window.BOX_TEXT_COLOR = jsonData.box_text_color;
                        jsonData.people.forEach(p => window.people.push({...p}));
                        jsonData.connections.forEach(c => {
                            if (c.person1_name && c.person2_name) {
                                // Find or create person1
                                let person1 = window.people.find(p => p.name === c.person1_name);
                                if (!person1) {
                                    person1 = {
                                        id: generatePersonId(c.person1_name),
                                        name: c.person1_name,
                                        role: '', x: 100, y: 100
                                    };
                                    window.people.push(person1);
                                }
                                // Find or create person2
                                let person2 = window.people.find(p => p.name === c.person2_name);
                                if (!person2) {
                                    person2 = {
                                        id: generatePersonId(c.person2_name),
                                        name: c.person2_name,
                                        role: '', x: 200, y: 100
                                    };
                                    window.people.push(person2);
                                }
                                window.connections.push({
                                    from: person1.id,
                                    to: person2.id,
                                    type: c.relationship_category || '',
                                    label: c.relationship_type || '',
                                    source_type: c.source_type || '',
                                    source_details: c.source_details || '',
                                    date: c.date || '',
                                    location: c.location || '',
                                    notes: c.notes || ''
                                });
                            } else {
                                // Already in internal format
                                window.connections.push({...c});
                            }
                        });
                        window.renderVisNetwork();
                        window.showUploadStatus('Loaded village_map.json successfully.', 'success');
                    } else {
                        window.showUploadStatus('village_map.json is missing people or connections array.', 'error');
                        window.renderVisNetwork();
                    }
                })
                .catch(err => {
                    window.people = [];
                    window.connections = [];
                    window.renderVisNetwork();
                    window.showUploadStatus('No default data found. Please upload or add data to begin.', 'info');
                });
        });

        // Attach refreshMap and showUploadStatus to window for global use
        window.showUploadStatus = showUploadStatus;

        // --- LEGEND FILTER CLICK HANDLERS ---
        document.querySelectorAll('.legend-item').forEach(item => {
            item.addEventListener('click', function() {
                const type = this.getAttribute('data-type');
                filterConnections(type);
            });
            item.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const type = this.getAttribute('data-type');
                    filterConnections(type);
                }
            });
        });

        // vis-network legend filter logic
        window.currentEdgeFilter = 'all';
        function filterConnections(type) {
            window.currentEdgeFilter = type;
            // Update legend active states
            document.querySelectorAll('.legend-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.legend-item.legend-${type}`).classList.add('active');
            window.renderVisNetwork();
        }
        window.filterConnections = filterConnections;

        // File handling functions
        function handleGedcomUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showUploadStatus('Processing GEDCOM file...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const gedcomContent = e.target.result;
                    parseGedcomData(gedcomContent);
                    showUploadStatus('GEDCOM file loaded successfully!', 'success');
                } catch (error) {
                    showUploadStatus('Error processing GEDCOM file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function handleCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showUploadStatus('Processing CSV file...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    parseCsvData(csvContent);
                    showUploadStatus('CSV file loaded successfully!', 'success');
                } catch (error) {
                    showUploadStatus('Error processing CSV file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function parseGedcomData(gedcomContent) {
            const lines = gedcomContent.split('\n');
            const individuals = {};
            const families = {};
            
            let currentRecord = null;
            let currentType = null;
            
            lines.forEach(line => {
                const parts = line.trim().split(' ');
                const level = parseInt(parts[0]);
                
                if (level === 0 && parts[2] === 'INDI') {
                    currentRecord = parts[1].replace(/@/g, '');
                    currentType = 'INDI';
                    individuals[currentRecord] = { id: currentRecord };
                } else if (level === 0 && parts[2] === 'FAM') {
                    currentRecord = parts[1].replace(/@/g, '');
                    currentType = 'FAM';
                    families[currentRecord] = { id: currentRecord };
                } else if (level === 1 && currentRecord) {
                    const tag = parts[1];
                    const value = parts.slice(2).join(' ').replace(/@/g, '');
                    
                    if (currentType === 'INDI') {
                        if (tag === 'NAME') {
                            individuals[currentRecord].name = value.replace(/\//g, '');
                        } else if (tag === 'OCCU') {
                            individuals[currentRecord].occupation = value;
                        }
                    } else if (currentType === 'FAM') {
                        if (tag === 'HUSB') {
                            families[currentRecord].husband = value;
                        } else if (tag === 'WIFE') {
                            families[currentRecord].wife = value;
                        } else if (tag === 'CHIL') {
                            if (!families[currentRecord].children) {
                                families[currentRecord].children = [];
                            }
                            families[currentRecord].children.push(value);
                        }
                    }
                }
            });
            
            addGedcomDataToMap(individuals, families);
        }

        function parseCsvData(csvContent) {
            const lines = csvContent.split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                if (values.length >= 4 && values[0] && values[1]) {
                    const person1Name = values[0];
                    const person2Name = values[1];

                    addPersonIfNotExists(person1Name, 'Unknown Role', people);
                    addPersonIfNotExists(person2Name, 'Unknown Role', people);

                    const person1Id = generatePersonId(person1Name);
                    const person2Id = generatePersonId(person2Name);
                    
                    const relationship = {
                        from: person1Id,
                        to: person2Id,
                        type: values[3] || 'social',
                        label: values[2] || 'connection',
                        source: values[5] || 'CSV import'
                    };
                    
                    connections.push(relationship);
                }
            }
            
            renderVisNetwork();
        }

        function addGedcomDataToMap(individuals, families) {
            Object.values(individuals).forEach(person => {
                if (person.name) {
                    addPersonIfNotExists(person.name, person.occupation || 'Unknown Role', people);
                }
            });
            
            Object.values(families).forEach(family => {
                if (family.husband && family.wife) {
                    const husband = individuals[family.husband];
                    const wife = individuals[family.wife];
                    if (husband && wife && husband.name && wife.name) {
                        const husbandId = generatePersonId(husband.name);
                        const wifeId = generatePersonId(wife.name);
                        connections.push({
                            from: husbandId,
                            to: wifeId,
                            type: 'family',
                            label: 'Married'
                        });
                    }
                }
                
                if (family.children) {
                    family.children.forEach(childId => {
                        const child = individuals[childId];
                        if (child && child.name) {
                            const childCleanId = generatePersonId(child.name);
                            if (family.husband) {
                                const father = individuals[family.husband];
                                if (father && father.name) {
                                    const fatherCleanId = generatePersonId(father.name);
                                    connections.push({
                                        from: fatherCleanId,
                                        to: childCleanId,
                                        type: 'family',
                                        label: 'Parent-Child'
                                    });
                                }
                            }
                            if (family.wife) {
                                const mother = individuals[family.wife];
                                if (mother && mother.name) {
                                    const motherCleanId = generatePersonId(mother.name);
                                    connections.push({
                                        from: motherCleanId,
                                        to: childCleanId,
                                        type: 'family',
                                        label: 'Parent-Child'
                                    });
                                }
                            }
                        }
                    });
                }
            });
            
            renderVisNetwork();
        }

        // vis-network rendering
        function renderVisNetwork() {
            // Two nodes per person: name and role
            const nodesArr = [];
            const roleColor = '#e3eaf7'; // light blue for role node
            window.people.forEach(p => {
                // Name node
                nodesArr.push({
                    id: p.id,
                    label: p.name,
                    shape: 'box',
                    color: {
                        background: (typeof BOX_COLOR !== 'undefined' ? BOX_COLOR : '#ffffff'),
                        border: '#34495e',
                        highlight: {
                            background: (typeof BOX_COLOR !== 'undefined' ? BOX_COLOR : '#ffffff'),
                            border: '#1976d2'
                        }
                    },
                    font: { size: 18, color: (typeof BOX_TEXT_COLOR !== 'undefined' ? BOX_TEXT_COLOR : '#2c3e50') }
                });
                // Role node (if present)
                if (p.role) {
                    nodesArr.push({
                        id: p.id + '_role',
                        label: p.role,
                        shape: 'box',
                        color: {
                            background: roleColor,
                            border: '#b0b8c1',
                            highlight: {
                                background: roleColor,
                                border: '#1976d2'
                            }
                        },
                        font: { size: 14, color: '#7f8c8d', ital: true },
                        physics: false
                    });
                }
            });
            const nodes = new vis.DataSet(nodesArr);

            // Edges: relationship edges between main nodes, and short edge from name to role
            const filterType = window.currentEdgeFilter || 'all';
            const edgesArr = window.connections
                .filter(c => filterType === 'all' || c.type === filterType)
                .map(c => ({
                    from: c.from,
                    to: c.to,
                    label: c.label || '',
                    color: c.type === 'family' ? '#e74c3c' : c.type === 'work' ? '#3498db' : '#2ecc71',
                    font: { size: 14, align: 'middle' },
                    width: (typeof CONNECTION_LINE_WIDTH !== 'undefined' ? CONNECTION_LINE_WIDTH : 2),
                    length: 300
                }));
            // Add short edge from name node to role node (always shown)
            window.people.forEach(p => {
                if (p.role) {
                    edgesArr.push({
                        from: p.id,
                        to: p.id + '_role',
                        color: { color: '#b0b8c1' },
                        width: 1,
                        length: 1,
                        physics: false,
                        arrows: { to: false },
                        label: ''
                    });
                }
            });
            const edges = new vis.DataSet(edgesArr);

            const container = document.getElementById('mapContainer');
            const data = { nodes, edges };
            const options = {
                layout: { improvedLayout: true },
                physics: { enabled: true, stabilization: true },
                nodes: {
                    shape: 'box',
                    margin: 10,
                    widthConstraint: { maximum: 180 }
                },
                edges: {
                    smooth: true,
                    arrows: { to: false },
                    width: (typeof CONNECTION_LINE_WIDTH !== 'undefined' ? CONNECTION_LINE_WIDTH : 2)
                },
                interaction: {
                    hover: true,
                    dragNodes: true,
                    zoomView: true,
                    dragView: true
                }
            };
            // Destroy previous network if exists
            if (window.visNetworkInstance) window.visNetworkInstance.destroy();
            window.visNetworkInstance = new vis.Network(container, data, options);

            // Double-click editing
            window.visNetworkInstance.on('doubleClick', function(params) {
                if (params.nodes.length === 1) {
                    // Edit person
                    window.openEditPersonModal(params.nodes[0]);
                } else if (params.edges.length === 1) {
                    // Find the edge index in your connections array
                    const edgeId = params.edges[0];
                    const edge = window.visNetworkInstance.body.data.edges.get(edgeId);
                    const connIndex = window.connections.findIndex((c) => {
                        return c.from === edge.from && c.to === edge.to && (c.label || '') === (edge.label || '');
                    });
                    if (connIndex !== -1) {
                        window.openEditConnectionModal(connIndex);
                    }
                }
            });
        }
        window.renderVisNetwork = renderVisNetwork;

        function showUploadStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.textContent = message;
            statusDiv.className = `upload-status upload-${type}`;
            statusDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // --- DOWNLOAD MAP AS JSON FUNCTION ---
        function downloadMapAsJSON() {
            // Map connections to the new format
            const formattedConnections = window.connections.map(conn => {
                const person1 = window.people.find(p => p.id === conn.from) || {};
                const person2 = window.people.find(p => p.id === conn.to) || {};
                return {
                    person1_name: person1.name || '',
                    person2_name: person2.name || '',
                    relationship_type: conn.label || '',
                    relationship_category: conn.type || '',
                    source_type: conn.source_type || '',
                    source_details: conn.source_details || '',
                    date: conn.date || '',
                    location: conn.location || '',
                    notes: conn.notes || ''
                };
            });
            const data = {
                people: window.people,
                connections: formattedConnections,
                box_color: (typeof BOX_COLOR !== 'undefined' ? BOX_COLOR : '#ffffff'),
                box_text_color: (typeof BOX_TEXT_COLOR !== 'undefined' ? BOX_TEXT_COLOR : '#2c3e50')
            };
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'village_map.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- HANDLE JSON UPLOAD FUNCTION ---
        function handleJsonUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            showUploadStatus('Processing JSON file...', 'info');
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    if (jsonData.people && jsonData.connections) {
                        // Replace current data
                        people.length = 0;
                        connections.length = 0;
                        if (jsonData.box_color) window.BOX_COLOR = jsonData.box_color;
                        if (jsonData.box_text_color) window.BOX_TEXT_COLOR = jsonData.box_text_color;
                        jsonData.people.forEach(p => people.push({...p}));
                        // Detect and convert CSV-style connections if needed
                        jsonData.connections.forEach(c => {
                            if (c.person1_name && c.person2_name) {
                                // Find or create person1
                                let person1 = people.find(p => p.name === c.person1_name);
                                if (!person1) {
                                    person1 = {
                                        id: generatePersonId(c.person1_name),
                                        name: c.person1_name,
                                        role: '', x: 100, y: 100
                                    };
                                    people.push(person1);
                                }
                                // Find or create person2
                                let person2 = people.find(p => p.name === c.person2_name);
                                if (!person2) {
                                    person2 = {
                                        id: generatePersonId(c.person2_name),
                                        name: c.person2_name,
                                        role: '', x: 200, y: 100
                                    };
                                    people.push(person2);
                                }
                                connections.push({
                                    from: person1.id,
                                    to: person2.id,
                                    type: c.relationship_category || '',
                                    label: c.relationship_type || '',
                                    source_type: c.source_type || '',
                                    source_details: c.source_details || '',
                                    date: c.date || '',
                                    location: c.location || '',
                                    notes: c.notes || ''
                                });
                            } else {
                                // Already in internal format
                                connections.push({...c});
                            }
                        });
                        renderVisNetwork();
                        showUploadStatus('JSON file loaded successfully!', 'success');
                    } else {
                        showUploadStatus('Invalid JSON format: missing people or connections.', 'error');
                    }
                } catch (error) {
                    showUploadStatus('Error processing JSON file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // --- MATERIAL DRAWER LOGIC ---
const openDrawerBtn = document.getElementById('openDrawerBtn');
const sideDrawer = document.getElementById('sideDrawer');
const drawerBackdrop = document.getElementById('drawerBackdrop');
function openDrawer() {
    sideDrawer.classList.add('open');
    drawerBackdrop.style.display = 'block';
    openDrawerBtn.setAttribute('aria-expanded', 'true');
    sideDrawer.focus();
}
function closeDrawer() {
    sideDrawer.classList.remove('open');
    drawerBackdrop.style.display = 'none';
    openDrawerBtn.setAttribute('aria-expanded', 'false');
}
openDrawerBtn.onclick = openDrawer;
drawerBackdrop.onclick = closeDrawer;
// Keyboard accessibility
document.addEventListener('keydown', function(e) {
    if (sideDrawer.classList.contains('open')) {
        if (e.key === 'Escape') closeDrawer();
    }
});
// Trap focus inside drawer when open
sideDrawer.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
        const focusable = sideDrawer.querySelectorAll('button, [tabindex]:not([tabindex=\"-1\"])');
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        if (e.shiftKey) {
            if (document.activeElement === first) {
                e.preventDefault();
                last.focus();
            }
        } else {
            if (document.activeElement === last) {
                e.preventDefault();
                first.focus();
            }
        }
    }
});

// About / Instructions modal logic
function openAboutModal() {
    // Close the drawer if open
    var sideDrawer = document.getElementById('sideDrawer');
    var drawerBackdrop = document.getElementById('drawerBackdrop');
    if (sideDrawer && sideDrawer.classList.contains('open')) {
        sideDrawer.classList.remove('open');
        if (drawerBackdrop) drawerBackdrop.style.display = 'none';
    }
    document.getElementById('aboutModal').style.display = 'flex';
    document.getElementById('aboutInstructions').innerHTML = '<strong>How to use:</strong> ' + (typeof INSTRUCTIONS !== 'undefined' ? INSTRUCTIONS.howToUse : '');
}
function closeAboutModal() {
    document.getElementById('aboutModal').style.display = 'none';
}
window.openAboutModal = openAboutModal;
window.closeAboutModal = closeAboutModal;

// Options modal logic
function openOptionsModal() {
    document.getElementById('optionsModal').style.display = 'flex';
    document.getElementById('boxColorInput').value = (typeof BOX_COLOR !== 'undefined' ? BOX_COLOR : '#ffffff');
    document.getElementById('boxTextColorInput').value = (typeof BOX_TEXT_COLOR !== 'undefined' ? BOX_TEXT_COLOR : '#2c3e50');
}
function closeOptionsModal() {
    document.getElementById('optionsModal').style.display = 'none';
}
window.openOptionsModal = openOptionsModal;
window.closeOptionsModal = closeOptionsModal;
document.getElementById('optionsForm').onsubmit = function(e) {
    e.preventDefault();
    window.BOX_COLOR = document.getElementById('boxColorInput').value;
    window.BOX_TEXT_COLOR = document.getElementById('boxTextColorInput').value;
    closeOptionsModal();
    window.renderVisNetwork();
};
    </script>
    <!-- Hidden file inputs for drawer upload buttons -->
    <input type="file" id="gedcomFile" accept=".ged" style="display: none;" onchange="handleGedcomUpload(event)">
    <input type="file" id="jsonFile" accept=".json" style="display: none;" onchange="handleJsonUpload(event)">
    <!-- About / Instructions Modal -->
    <div id="aboutModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:3000; align-items:center; justify-content:center;">
      <div style="background:#fff; padding:24px 32px; border-radius:10px; min-width:300px; max-width:90vw; box-shadow:0 8px 32px rgba(0,0,0,0.2); position:relative;">
        <h3>About / Instructions</h3>
        <div id="aboutInstructions"></div>
        <div style="text-align:right; margin-top:16px;">
          <button type="button" onclick="closeAboutModal()">Close</button>
        </div>
      </div>
    </div>
    <!-- Options Modal -->
    <div id="optionsModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:3000; align-items:center; justify-content:center;">
      <div style="background:#fff; padding:24px 32px; border-radius:10px; min-width:300px; max-width:90vw; box-shadow:0 8px 32px rgba(0,0,0,0.2); position:relative;">
        <h3>Options</h3>
        <form id="optionsForm">
          <label>Box Color:<br><input type="color" id="boxColorInput" value="#ffffff" style="width: 60px; height: 32px;"></label><br><br>
          <label>Box Text Color:<br><input type="color" id="boxTextColorInput" value="#2c3e50" style="width: 60px; height: 32px;"></label><br><br>
          <div style="text-align:right; margin-top:16px;">
            <button type="button" onclick="closeOptionsModal()">Cancel</button>
            <button type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>
</body>
</html>